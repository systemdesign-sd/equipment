<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨­å‚™å°å¸³ | æ ªå¼ä¼šç¤¾ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
:root {
  --bg:#f5f2ec;--bg-card:#ffffff;--bg-panel:#f0ece4;
  --border:#ddd8ce;--border-md:#c8c2b6;
  --text-1:#1a1714;--text-2:#5a5450;--text-3:#9a948c;
  --accent:#1a1714;--accent2:#d94f3a;--accent3:#4a7c6f;
  --gold:#c9993a;--white:#ffffff;
  --shadow-sm:0 1px 4px rgba(0,0,0,0.06);
  --shadow-md:0 4px 20px rgba(0,0,0,0.08);
  --shadow-lg:0 12px 48px rgba(0,0,0,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text-1);min-height:100vh;}

/* LOGIN */
#loginScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;}
.login-card{background:var(--white);border:1px solid var(--border);border-radius:14px;padding:44px 40px 36px;width:360px;box-shadow:var(--shadow-lg);text-align:center;}
.login-logo{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:24px;}
.login-logo-mark{width:38px;height:38px;}
.login-company{font-size:14px;font-weight:900;color:var(--text-1);text-align:left;line-height:1.3;}
.login-company-sub{font-size:9px;color:var(--text-3);letter-spacing:0.04em;}
.login-divider{width:100%;height:1px;background:var(--border);margin-bottom:24px;}
.login-title{font-size:16px;font-weight:700;color:var(--text-1);margin-bottom:6px;}
.login-sub{font-size:11px;color:var(--text-3);margin-bottom:28px;line-height:1.7;}
.ms-login-btn{width:100%;padding:13px 16px;background:var(--accent);color:var(--white);border:none;border-radius:7px;font-size:13px;font-family:'Noto Sans JP',sans-serif;font-weight:700;letter-spacing:0.06em;cursor:pointer;transition:background 0.15s;display:flex;align-items:center;justify-content:center;gap:10px;}
.ms-login-btn:hover{background:#2d2a26;}
.ms-icon{width:18px;height:18px;flex-shrink:0;}
.login-loading{display:none;font-family:'DM Mono',monospace;font-size:11px;color:var(--text-3);margin-top:14px;letter-spacing:0.1em;}
.login-note{font-size:10px;color:var(--text-3);margin-top:16px;line-height:1.7;}

/* APP */
#app{display:none;}
.sync-bar{padding:5px 20px;background:rgba(74,124,111,0.08);border-bottom:1px solid rgba(74,124,111,0.15);font-family:'DM Mono',monospace;font-size:9px;color:var(--accent3);letter-spacing:0.1em;display:none;align-items:center;gap:6px;}
.sync-bar.show{display:flex;}

/* HEADER */
header{background:var(--white);border-bottom:2px solid var(--border);height:58px;display:flex;align-items:center;padding:0 24px;position:sticky;top:0;z-index:50;box-shadow:var(--shadow-sm);}
.logo-wrap{display:flex;align-items:center;gap:10px;}
.logo-mark{width:30px;height:30px;flex-shrink:0;}
.logo-company{font-size:13px;font-weight:900;color:var(--text-1);letter-spacing:0.02em;line-height:1.2;}
.logo-sub{font-size:9px;font-weight:400;color:var(--text-3);letter-spacing:0.04em;}
.hd{width:1px;height:26px;background:var(--border);margin:0 18px;}
.system-title{font-size:14px;font-weight:700;color:var(--text-1);letter-spacing:0.04em;}
.system-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.15em;text-transform:uppercase;margin-top:1px;}
.header-spacer{flex:1;}
.user-pill{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-2);margin-right:12px;}
.user-avatar{width:24px;height:24px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--white);font-weight:700;}
.online-pill{display:flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.12em;padding:4px 10px;border:1px solid var(--border);border-radius:20px;margin-right:12px;}
.online-dot{width:5px;height:5px;background:#3d9970;border-radius:50%;box-shadow:0 0 5px #3d9970;animation:blink 2.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.logout-btn{padding:6px 14px;background:transparent;border:1px solid var(--border-md);border-radius:5px;font-size:11px;font-family:'DM Mono',monospace;color:var(--text-3);cursor:pointer;letter-spacing:0.08em;transition:all 0.15s;}
.logout-btn:hover{border-color:var(--accent2);color:var(--accent2);}

/* LAYOUT */
.layout{display:grid;grid-template-columns:1fr 360px;gap:0;min-height:calc(100vh - 58px);}
.pane-list{padding:20px;border-right:1px solid var(--border);overflow-y:auto;}
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.toolbar-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.2em;text-transform:uppercase;padding-right:10px;border-right:1px solid var(--border);margin-right:2px;white-space:nowrap;}
.tb-select{padding:6px 24px 6px 10px;background:var(--white) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%239a948c' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 8px center;border:1px solid var(--border);border-radius:5px;font-size:12px;font-family:'Noto Sans JP',sans-serif;color:var(--text-1);appearance:none;cursor:pointer;}
.tb-select:focus{outline:none;border-color:var(--accent);}
.tb-search{flex:1;min-width:140px;max-width:220px;padding:6px 10px;background:var(--white);border:1px solid var(--border);border-radius:5px;font-size:12px;font-family:'Noto Sans JP',sans-serif;color:var(--text-1);}
.tb-search::placeholder{color:var(--text-3);}
.tb-search:focus{outline:none;border-color:var(--accent);}
.count-chip{font-family:'DM Mono',monospace;font-size:11px;color:var(--text-2);padding:5px 10px;background:var(--bg-panel);border:1px solid var(--border);border-radius:5px;margin-left:auto;white-space:nowrap;}
.count-chip b{color:var(--text-1);}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer;transition:all 0.2s;box-shadow:var(--shadow-sm);}
.card:hover{border-color:var(--border-md);transform:translateY(-2px);box-shadow:var(--shadow-md);}
.card.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(26,23,20,0.12);}
.card-top{height:2px;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform 0.2s;}
.card:hover .card-top,.card.selected .card-top{transform:scaleX(1);}
.card-photo{width:100%;height:140px;background:var(--bg-panel);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:44px;overflow:hidden;}
.card-photo img{width:100%;height:100%;object-fit:cover;}
.card-body{padding:11px 13px 10px;}
.card-row1{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:5px;}
.card-name{font-size:13px;font-weight:700;color:var(--text-1);line-height:1.4;flex:1;padding-right:6px;}
.badge-ai{font-family:'DM Mono',monospace;font-size:8px;padding:2px 5px;background:rgba(217,79,58,0.08);border:1px solid rgba(217,79,58,0.2);border-radius:3px;color:var(--accent2);letter-spacing:0.08em;white-space:nowrap;flex-shrink:0;}
.card-maker{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-3);margin-bottom:8px;}
.tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;}
.tag{font-size:10px;font-weight:500;padding:2px 7px;border-radius:3px;}
.tag-bank{background:rgba(74,124,111,0.1);border:1px solid rgba(74,124,111,0.2);color:var(--accent3);}
.tag-branch{background:var(--bg-panel);border:1px solid var(--border);color:var(--text-2);}
.card-desc{font-size:11px;color:var(--text-2);line-height:1.7;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.card-footer{padding:8px 13px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-date{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);}
.card-open{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-3);background:none;border:none;cursor:pointer;letter-spacing:0.1em;padding:0;}
.card:hover .card-open,.card.selected .card-open{color:var(--text-1);}

/* RIGHT PANE */
.pane-right{background:var(--white);display:flex;flex-direction:column;position:sticky;top:58px;height:calc(100vh - 58px);overflow-y:auto;}
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab-btn{flex:1;padding:12px 0;font-size:12px;font-weight:700;font-family:'Noto Sans JP',sans-serif;letter-spacing:0.04em;background:transparent;border:none;cursor:pointer;color:var(--text-3);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.tab-btn.active{color:var(--text-1);border-bottom-color:var(--accent);}
.tab-btn:hover:not(.active){color:var(--text-2);background:var(--bg);}
.tab-content{display:none;flex:1;overflow-y:auto;}
.tab-content.active{display:block;}
.det-photo{width:100%;height:200px;background:var(--bg-panel);display:flex;align-items:center;justify-content:center;font-size:60px;overflow:hidden;position:relative;border-bottom:1px solid var(--border);}
.det-photo img{width:100%;height:100%;object-fit:cover;}
.det-id-strip{position:absolute;bottom:0;left:0;right:0;padding:5px 14px;background:rgba(245,242,236,0.95);display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.1em;border-top:1px solid var(--border);}
.det-body{padding:16px 18px;}
.det-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.det-name{font-size:18px;font-weight:900;color:var(--text-1);margin-bottom:4px;line-height:1.3;}
.det-maker{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-3);margin-bottom:14px;}
.det-sec{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:7px;}
.det-desc{font-size:12px;color:var(--text-2);line-height:1.85;}
.det-ai{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent2);margin-bottom:10px;display:flex;align-items:center;gap:4px;}
.det-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px 20px;text-align:center;color:var(--text-3);}
.det-empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3;}
.det-empty-text{font-size:13px;color:var(--text-2);margin-bottom:6px;}
.det-empty-sub{font-size:11px;}
.form-wrap{padding:16px 18px;}
.fsec{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.fsec:last-of-type{border-bottom:none;}
.fsec-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-3);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:10px;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.fg{margin-bottom:8px;}
.fg:last-child{margin-bottom:0;}
.fl{display:block;font-size:11px;font-weight:500;color:var(--text-2);margin-bottom:3px;}
.fl .req{color:var(--accent2);margin-left:2px;}
.fi,.fta{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;font-size:12px;font-family:'Noto Sans JP',sans-serif;color:var(--text-1);transition:border-color 0.15s;}
.fi::placeholder,.fta::placeholder{color:var(--text-3);}
.fi:focus,.fta:focus{outline:none;border-color:var(--accent);background:var(--white);}
.fta{resize:vertical;min-height:80px;line-height:1.7;}
.upload-zone{border:1.5px dashed var(--border-md);border-radius:6px;padding:16px;text-align:center;cursor:pointer;position:relative;background:var(--bg);transition:all 0.15s;}
.upload-zone:hover{border-color:var(--accent);background:var(--bg-panel);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-zone-icon{font-size:20px;margin-bottom:4px;}
.upload-zone-text{font-size:11px;color:var(--text-2);}
.upload-zone-sub{font-size:10px;color:var(--text-3);margin-top:2px;}
.upload-preview{width:100%;max-height:120px;object-fit:cover;border-radius:5px;margin-top:8px;display:none;}
.ai-btn{display:inline-flex;align-items:center;gap:5px;margin-top:6px;padding:6px 12px;background:rgba(217,79,58,0.06);border:1px solid rgba(217,79,58,0.18);border-radius:5px;font-size:11px;font-family:'DM Mono',monospace;color:var(--accent2);cursor:pointer;letter-spacing:0.06em;transition:all 0.15s;}
.ai-btn:hover{background:rgba(217,79,58,0.1);}
.ai-loading{display:none;font-family:'DM Mono',monospace;font-size:10px;color:var(--text-3);margin-top:5px;}
.btn-submit{width:100%;padding:11px;background:var(--accent);color:var(--white);border:none;border-radius:6px;font-size:13px;font-family:'Noto Sans JP',sans-serif;font-weight:700;letter-spacing:0.06em;cursor:pointer;margin-top:4px;transition:background 0.15s;}
.btn-submit:hover{background:#2d2a26;}
.btn-submit:disabled{background:#9a948c;cursor:not-allowed;}
.success-msg{display:none;padding:10px 14px;margin-bottom:12px;background:rgba(74,124,111,0.1);border:1px solid rgba(74,124,111,0.25);border-radius:6px;font-size:12px;color:var(--accent3);font-weight:500;}
.error-msg{display:none;padding:10px 14px;margin-bottom:12px;background:rgba(217,79,58,0.08);border:1px solid rgba(217,79,58,0.2);border-radius:6px;font-size:12px;color:var(--accent2);}
.empty{grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--text-3);}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:.4;}
.empty-text{font-size:13px;margin-bottom:5px;color:var(--text-2);}
.empty-sub{font-size:11px;}
.pdf-bar{padding:10px 20px;border-top:1px solid var(--border);background:var(--white);flex-shrink:0;}
.btn-pdf{width:100%;padding:8px;background:transparent;border:1px solid var(--border-md);border-radius:5px;font-size:11px;font-family:'DM Mono',monospace;color:var(--text-2);letter-spacing:0.08em;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn-pdf:hover{border-color:var(--gold);color:var(--gold);}
@media print{header,.pane-right,.toolbar{display:none !important;}.layout{display:block;}body{background:white;}.grid{grid-template-columns:repeat(3,1fr);}.card{break-inside:avoid;box-shadow:none;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <svg class="login-logo-mark" viewBox="0 0 38 38" fill="none">
        <path d="M6 32 L16 6" stroke="#1a1714" stroke-width="3.8" stroke-linecap="round"/>
        <path d="M20 6 L20 32" stroke="#1a1714" stroke-width="3.8" stroke-linecap="round"/>
        <path d="M20 6 Q33 6 33 19 Q33 32 20 32" stroke="#1a1714" stroke-width="3.8" stroke-linecap="round" fill="none"/>
      </svg>
      <div>
        <div class="login-company">æ ªå¼ä¼šç¤¾ ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</div>
        <div class="login-company-sub">SYSTEM DESIGN Co., Ltd.</div>
      </div>
    </div>
    <div class="login-divider"></div>
    <div class="login-title">é‡‘èæ©Ÿé–¢ è¨­å‚™å°å¸³</div>
    <div class="login-sub">Microsoft 365ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br>ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚</div>
    <button class="ms-login-btn" onclick="signIn()">
      <svg class="ms-icon" viewBox="0 0 21 21" fill="none">
        <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
        <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
        <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
        <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
      </svg>
      Microsoft 365 ã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    <div class="login-loading" id="loginLoading">â— èªè¨¼ä¸­...</div>
    <div class="login-note">ç¤¾å†…å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ç¤¾å¤–ã¸ã®å…±æœ‰ãƒ»å…¬é–‹ç¦æ­¢ã€‚</div>
  </div>
</div>

<!-- APP -->
<div id="app">
<div class="sync-bar" id="syncBar">â— OneDrive ã¨åŒæœŸæ¸ˆã¿</div>
<header>
  <div class="logo-wrap">
    <svg class="logo-mark" viewBox="0 0 30 30" fill="none">
      <path d="M5 25 L13 5" stroke="#1a1714" stroke-width="3.2" stroke-linecap="round"/>
      <path d="M16 5 L16 25" stroke="#1a1714" stroke-width="3.2" stroke-linecap="round"/>
      <path d="M16 5 Q26 5 26 15 Q26 25 16 25" stroke="#1a1714" stroke-width="3.2" stroke-linecap="round" fill="none"/>
    </svg>
    <div>
      <div class="logo-company">æ ªå¼ä¼šç¤¾ ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</div>
      <div class="logo-sub">SYSTEM DESIGN Co., Ltd.</div>
    </div>
  </div>
  <div class="hd"></div>
  <div>
    <div class="system-title">é‡‘èæ©Ÿé–¢ è¨­å‚™å°å¸³</div>
    <div class="system-sub">Financial Equipment Registry</div>
  </div>
  <div class="header-spacer"></div>
  <div class="user-pill">
    <div class="user-avatar" id="userAvatar">â€”</div>
    <span id="userName">â€”</span>
  </div>
  <div class="online-pill"><div class="online-dot"></div>ONLINE</div>
  <button class="logout-btn" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</header>

<div class="layout">
  <div class="pane-list">
    <div class="toolbar">
      <span class="toolbar-label">FILTER</span>
      <select class="tb-select" id="filterBank" onchange="applyFilters()"><option value="">ã™ã¹ã¦ã®é‡‘èæ©Ÿé–¢</option></select>
      <select class="tb-select" id="filterBranch" onchange="applyFilters()"><option value="">ã™ã¹ã¦ã®æ”¯åº—</option></select>
      <input class="tb-search" type="text" id="filterSearch" placeholder="æ©Ÿå™¨åã§æ¤œç´¢..." oninput="applyFilters()">
      <div class="count-chip" id="countChip">â€” ä»¶</div>
    </div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="pane-right">
    <div class="tabs">
      <button class="tab-btn active" id="tabDetail" onclick="switchTab('detail')">è©³ç´°</button>
      <button class="tab-btn" id="tabReg" onclick="switchTab('reg')">ï¼‹ æ–°è¦ç™»éŒ²</button>
    </div>
    <div class="tab-content active" id="contentDetail">
      <div id="detEmpty" class="det-empty">
        <div class="det-empty-icon">ğŸ‘†</div>
        <div class="det-empty-text">å·¦ã®æ©Ÿå™¨ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
        <div class="det-empty-sub">è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <div id="detContent" style="display:none;">
        <div class="det-photo" id="detPhoto"></div>
        <div class="det-body">
          <div class="det-tags" id="detTags"></div>
          <div class="det-name" id="detName"></div>
          <div class="det-maker" id="detMaker"></div>
          <div id="detAiNote"></div>
          <div class="det-sec">æ©Ÿå™¨è§£èª¬</div>
          <div class="det-desc" id="detDesc"></div>
        </div>
      </div>
    </div>
    <div class="tab-content" id="contentReg">
      <div class="form-wrap">
        <div class="success-msg" id="successMsg">âœ“ OneDriveã«ä¿å­˜ã—ã¾ã—ãŸï¼</div>
        <div class="error-msg" id="errorMsg"></div>
        <div class="fsec">
          <div class="fsec-title">01 â€” å†™çœŸ</div>
          <div class="upload-zone">
            <input type="file" accept="image/*" id="photoInput" onchange="prevPhoto(this)">
            <div id="upIcon" class="upload-zone-icon">ğŸ“·</div>
            <div id="upText" class="upload-zone-text">ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
            <div id="upSub" class="upload-zone-sub">JPG / PNG / HEIC</div>
            <img id="upPreview" class="upload-preview">
          </div>
        </div>
        <div class="fsec">
          <div class="fsec-title">02 â€” æ©Ÿå™¨æƒ…å ±</div>
          <div class="frow">
            <div class="fg"><label class="fl">æ©Ÿå™¨åç§°<span class="req">*</span></label><input class="fi" id="iName" placeholder="ãƒ†ãƒ©ãƒ¼ãƒã‚·ãƒ³"></div>
            <div class="fg"><label class="fl">ãƒ¡ãƒ¼ã‚«ãƒ¼</label><input class="fi" id="iMaker" placeholder="ã‚°ãƒ­ãƒ¼ãƒªãƒ¼ãˆ±"></div>
          </div>
        </div>
        <div class="fsec">
          <div class="fsec-title">03 â€” è¨­ç½®å…ˆ</div>
          <div class="frow">
            <div class="fg"><label class="fl">é‡‘èæ©Ÿé–¢<span class="req">*</span></label><input class="fi" id="iBank" placeholder="ãã‚‰ã¼ã—éŠ€è¡Œ"></div>
            <div class="fg"><label class="fl">æ”¯åº—å</label><input class="fi" id="iBranch" placeholder="è±Šæ´²æ”¯åº—"></div>
          </div>
        </div>
        <div class="fsec">
          <div class="fsec-title">04 â€” æ©Ÿå™¨è§£èª¬</div>
          <textarea class="fta" id="iDesc" placeholder="ç”¨é€”ãƒ»æ©Ÿèƒ½ãƒ»è¨­ç½®æ™‚ã®æ³¨æ„ç‚¹ãªã©..."></textarea>
          <button class="ai-btn" id="aiBtn" onclick="genAI()">âœ¦ AIã§è§£èª¬æ–‡ã‚’è‡ªå‹•ç”Ÿæˆ</button>
          <div class="ai-loading" id="aiLoading">âœ¦ ç”Ÿæˆä¸­...</div>
        </div>
        <button class="btn-submit" id="submitBtn" onclick="registerEq()">ç™» éŒ² ã™ ã‚‹</button>
      </div>
    </div>
    <div class="pdf-bar">
      <button class="btn-pdf" onclick="window.print()">ğŸ–¨ PDFå‡ºåŠ›ï¼ˆå°åˆ·ï¼‰</button>
    </div>
  </div>
</div>
</div>

<script>
// ===== è¨­å®šï¼ˆå¤‰æ›´ä¸è¦ï¼‰ =====
const CLIENT_ID = 'e7caa6fe-84d9-4fd6-821a-72ff7a9bb989';
const TENANT_ID = 'a0ce6143-a347-47f4-991d-97b926c598c6';
const SITE_PATH = '/sites/stdn';
const EXCEL_ITEM_PATH = `${SITE_PATH}/Shared%20Documents/SP%E5%85%B1%E6%9C%89%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80/%E8%A8%AD%E5%82%99%E5%8F%B0%E5%B8%B3/%E8%A8%AD%E5%82%99%E5%8F%B0%E5%B8%B3DB.xlsx`;
const SHEET = 'Sheet1';

const msalConfig = {
  auth: {
    clientId: CLIENT_ID,
    authority: `https://login.microsoftonline.com/${TENANT_ID}`,
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const scopes = ['Files.ReadWrite', 'User.Read'];

let db = [];
let photoFile = null;
let aiUsed = false;

// ===== èªè¨¼ =====
async function signIn() {
  document.getElementById('loginLoading').style.display = 'block';
  try {
    const result = await msalInstance.loginPopup({ scopes });
    const account = msalInstance.getAllAccounts()[0];
    initUser(account);
    await loadData();
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
  } catch(e) {
    document.getElementById('loginLoading').style.display = 'none';
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Microsoft 365ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + (e.message || e));
  }
}

async function getToken() {
  const account = msalInstance.getAllAccounts()[0];
  if (!account) return null;
  try {
    const r = await msalInstance.acquireTokenSilent({ scopes, account });
    return r.accessToken;
  } catch {
    const r = await msalInstance.acquireTokenPopup({ scopes });
    return r.accessToken;
  }
}

function initUser(account) {
  const name = account.name || account.username || '';
  document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('userName').textContent = name.split('@')[0];
}

function signOut() {
  msalInstance.logoutPopup();
}

// ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
async function loadData() {
  try {
    const token = await getToken();
    const url = `https://graph.microsoft.com/v1.0${EXCEL_ITEM_PATH}:/workbook/worksheets('${SHEET}')/usedRange`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { buildFilters(); applyFilters(); return; }
    const data = await res.json();
    const rows = data.values || [];
    db = rows.slice(1).filter(r => r[1]).map(r => ({
      id: String(r[0] || Date.now()),
      name: r[1] || '',
      maker: r[2] || '',
      bank: r[3] || '',
      branch: r[4] || '',
      desc: r[5] || '',
      photoUrl: r[6] || null,
      date: r[7] || '',
      ai: r[8] === true || r[8] === 'TRUE' || r[8] === 1,
      emoji: r[9] || 'ğŸ“¦'
    }));
    showSync();
  } catch(e) {
    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    db = [];
  }
  buildFilters();
  applyFilters();
}

// ===== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ =====
async function saveRow(eq) {
  try {
    const token = await getToken();
    const nextRow = db.length + 2; // ãƒ˜ãƒƒãƒ€ãƒ¼1è¡Œ + æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ + æ–°è¦
    const range = `A${nextRow}:J${nextRow}`;
    const url = `https://graph.microsoft.com/v1.0${EXCEL_ITEM_PATH}:/workbook/worksheets('${SHEET}')/range(address='${range}')`;
    const res = await fetch(url, {
      method: 'PATCH',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: [[eq.id, eq.name, eq.maker, eq.bank, eq.branch, eq.desc, eq.photoUrl || '', eq.date, eq.ai, eq.emoji]] })
    });
    return res.ok;
  } catch(e) {
    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    return false;
  }
}

// ===== å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
async function uploadPhoto(file, id) {
  try {
    const token = await getToken();
    const ext = file.name.split('.').pop();
    const name = `${id}.${ext}`;
    const path = `${SITE_PATH}/Shared%20Documents/SP%E5%85%B1%E6%9C%89%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80/%E8%A8%AD%E5%82%99%E5%8F%B0%E5%B8%B3/%E5%86%99%E7%9C%9F/${name}`;
    const url = `https://graph.microsoft.com/v1.0${path}:/content`;
    const res = await fetch(url, {
      method: 'PUT',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': file.type },
      body: file
    });
    if (res.ok) { const d = await res.json(); return d.webUrl || null; }
    return null;
  } catch { return null; }
}

function showSync() {
  const bar = document.getElementById('syncBar');
  bar.classList.add('show');
  setTimeout(() => bar.classList.remove('show'), 3000);
}

// ===== UI =====
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const t = tab.charAt(0).toUpperCase() + tab.slice(1);
  document.getElementById('tab' + t).classList.add('active');
  document.getElementById('content' + t).classList.add('active');
}

function renderGrid(data) {
  const g = document.getElementById('grid');
  document.getElementById('countChip').innerHTML = `<b>${data.length}</b> / ${db.length} ä»¶`;
  if (!data.length) {
    g.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ¦</div><div class="empty-text">è©²å½“ã™ã‚‹æ©Ÿå™¨ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-sub">æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„</div></div>`;
    return;
  }
  g.innerHTML = data.map(eq => `
    <div class="card" id="card-${eq.id}" onclick="selectCard('${eq.id}')">
      <div class="card-top"></div>
      <div class="card-photo">${eq.photoUrl ? `<img src="${eq.photoUrl}">` : eq.emoji}</div>
      <div class="card-body">
        <div class="card-row1"><div class="card-name">${eq.name}</div>${eq.ai ? `<span class="badge-ai">AI</span>` : ''}</div>
        <div class="card-maker">${eq.maker || 'â€”'}</div>
        <div class="tags"><span class="tag tag-bank">${eq.bank}</span>${eq.branch ? `<span class="tag tag-branch">${eq.branch}</span>` : ''}</div>
        <div class="card-desc">${eq.desc || 'è§£èª¬æœªå…¥åŠ›'}</div>
      </div>
      <div class="card-footer"><span class="card-date">ç™»éŒ² ${eq.date}</span><span class="card-open">è©³ç´° â†’</span></div>
    </div>`).join('');
}

function selectCard(id) {
  const eq = db.find(e => e.id === id); if (!eq) return;
  document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
  const el = document.getElementById('card-' + id); if (el) el.classList.add('selected');
  document.getElementById('detEmpty').style.display = 'none';
  document.getElementById('detContent').style.display = 'block';
  document.getElementById('detPhoto').innerHTML = `
    ${eq.photoUrl ? `<img src="${eq.photoUrl}">` : `<span style="font-size:56px">${eq.emoji}</span>`}
    <div class="det-id-strip"><span>ID-${eq.id.toString().slice(-4)}</span><span>${eq.date}</span></div>`;
  document.getElementById('detTags').innerHTML = `<span class="tag tag-bank">${eq.bank}</span>${eq.branch ? `<span class="tag tag-branch">${eq.branch}</span>` : ''}`;
  document.getElementById('detName').textContent = eq.name;
  document.getElementById('detMaker').textContent = eq.maker || '';
  document.getElementById('detAiNote').innerHTML = eq.ai ? `<div class="det-ai">âœ¦ AIè‡ªå‹•ç”Ÿæˆè§£èª¬</div>` : '';
  document.getElementById('detDesc').textContent = eq.desc || 'è§£èª¬æœªå…¥åŠ›';
  switchTab('detail');
}

function buildFilters() {
  const banks = [...new Set(db.map(e => e.bank).filter(Boolean))].sort();
  const bs = document.getElementById('filterBank');
  bs.innerHTML = '<option value="">ã™ã¹ã¦ã®é‡‘èæ©Ÿé–¢</option>';
  banks.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; bs.appendChild(o); });
}

function applyFilters() {
  const bank = document.getElementById('filterBank').value;
  const brs = document.getElementById('filterBranch');
  const curBr = brs.value;
  const branches = [...new Set(db.filter(e => !bank || e.bank === bank).map(e => e.branch).filter(Boolean))].sort();
  brs.innerHTML = '<option value="">ã™ã¹ã¦ã®æ”¯åº—</option>';
  branches.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; if (b === curBr) o.selected = true; brs.appendChild(o); });
  const search = document.getElementById('filterSearch').value.toLowerCase();
  const branch = brs.value;
  renderGrid(db.filter(e => (!bank || e.bank === bank) && (!branch || e.branch === branch) && (!search || e.name.toLowerCase().includes(search) || (e.desc || '').toLowerCase().includes(search))));
}

function prevPhoto(input) {
  if (input.files && input.files[0]) {
    photoFile = input.files[0];
    const r = new FileReader();
    r.onload = e => {
      document.getElementById('upPreview').src = e.target.result;
      document.getElementById('upPreview').style.display = 'block';
      ['upIcon','upText','upSub'].forEach(i => document.getElementById(i).style.display = 'none');
    };
    r.readAsDataURL(input.files[0]);
  }
}

async function genAI() {
  const name = document.getElementById('iName').value.trim();
  if (!name) { alert('æ©Ÿå™¨åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  const maker = document.getElementById('iMaker').value.trim();
  const bank = document.getElementById('iBank').value.trim();
  document.getElementById('aiLoading').style.display = 'block';
  document.getElementById('aiBtn').style.display = 'none';
  try {
    const prompt = `é‡‘èæ©Ÿé–¢ã®å†…è£…å·¥äº‹ä¼šç¤¾å‘ã‘ã«ã€Œ${name}ã€ã®è¨­å‚™è§£èª¬æ–‡ã‚’150ã€œ200å­—ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚${maker ? `ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼š${maker}ã€‚` : ''}${bank ? `è¨­ç½®å…ˆï¼š${bank}ã€‚` : ''}\nå«ã‚ã‚‹å†…å®¹ï¼šâ‘ ç”¨é€”ãƒ»æ©Ÿèƒ½ â‘¡è¨­ç½®å ´æ‰€ â‘¢å†…è£…å·¥äº‹æ™‚ã®æ³¨æ„ç‚¹\nè§£èª¬æ–‡ã®ã¿è¿”ç­”ã—ã¦ãã ã•ã„ã€‚`;
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1000, messages: [{ role: "user", content: prompt }] })
    });
    const data = await res.json();
    document.getElementById('iDesc').value = data.content?.find(c => c.type === 'text')?.text?.trim() || '';
    aiUsed = true;
  } catch { document.getElementById('iDesc').value = `${name}ã¯é‡‘èæ©Ÿé–¢ã®çª“å£æ¥­å‹™ã«ä½¿ç”¨ã•ã‚Œã‚‹æ©Ÿå™¨ã§ã™ã€‚`; }
  document.getElementById('aiLoading').style.display = 'none';
}

async function registerEq() {
  const name = document.getElementById('iName').value.trim();
  const bank = document.getElementById('iBank').value.trim();
  if (!name || !bank) { alert('æ©Ÿå™¨åç§°ã¨é‡‘èæ©Ÿé–¢ã¯å¿…é ˆã§ã™ã€‚'); return; }
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
  const id = String(Date.now());
  let photoUrl = null;
  if (photoFile) photoUrl = await uploadPhoto(photoFile, id);
  const newEq = { id, name, maker: document.getElementById('iMaker').value.trim(), bank, branch: document.getElementById('iBranch').value.trim(), desc: document.getElementById('iDesc').value.trim(), photoUrl, date: new Date().toISOString().slice(0,10), ai: aiUsed, emoji: 'ğŸ“¦' };
  const saved = await saveRow(newEq);
  btn.disabled = false; btn.textContent = 'ç™» éŒ² ã™ ã‚‹';
  if (saved) {
    db.unshift(newEq);
    ['iName','iMaker','iBank','iBranch','iDesc'].forEach(i => document.getElementById(i).value = '');
    document.getElementById('upPreview').style.display = 'none';
    ['upIcon','upText','upSub'].forEach(i => document.getElementById(i).style.display = '');
    document.getElementById('aiBtn').style.display = '';
    photoFile = null; aiUsed = false;
    const msg = document.getElementById('successMsg'); msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 4000);
    buildFilters(); applyFilters(); showSync();
    setTimeout(() => selectCard(newEq.id), 100);
  } else {
    const err = document.getElementById('errorMsg');
    err.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    err.style.display = 'block';
    setTimeout(() => err.style.display = 'none', 4000);
  }
}

msalInstance.handleRedirectPromise().catch(() => {});
</script>
</body>
</html>
